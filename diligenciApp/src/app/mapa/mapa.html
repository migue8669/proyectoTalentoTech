<div class="map-container">
  <div class="header">
    <div class="brand">
      <h1>🌍 DiligenciApp</h1>
      <p>Diligencias y Servicios</p>
    </div>
    <div class="btn-group" role="group" aria-label="Basic mixed styles example">
      <button
        type="button"
        class="btn btn-outline-success"
        (click)="toggleVista()"
        title="Alternar vista"
      >
        {{ mostrarMuro ? 'Mapa' : 'Muro' }}
      </button>
      <button
        type="button"
        class="btn btn-outline-primary"
        (click)="loadMarkers()"
        title="Recargar marcadores"
      >
        &#x27F3;
      </button>
      <button
        type="button"
        class="btn btn-outline-secondary"
        (click)="logout()"
        title="Cerrar sesión"
      >
        X
      </button>
    </div>
  </div>

  <google-map
    *ngIf="mostrarMapa"
    height="450px"
    width="100%"
    [options]="mapOptions"
    [center]="center"
    [zoom]="zoom"
  >
    <map-marker
      *ngFor="let marker of markerPositions; trackBy: trackByMarkerId"
      #markerElem="mapMarker"
      [position]="{ lat: marker.lat, lng: marker.lng }"
      [title]="marker.titulo"
      (mapClick)="openInfoWindow(marker, markerElem, infoWindow)"
    ></map-marker>

    <map-info-window #infoWindow="mapInfoWindow">
      <div class="info-window" *ngIf="selectedMarker">
        <!-- Título y detalles -->
        <strong>{{ selectedMarker.titulo }}</strong>
        <span>Servicio: {{ selectedMarker.servicio }}</span>
        <span>Categoria: {{ selectedMarker.categoria }}</span>
        <span>Teléfono: {{ selectedMarker.telefono }}</span>
        <small>📍 {{ selectedMarker.direccion }}</small>

        <!-- SECCIÓN DE ESTADO (Separada del botón de acción) -->
        <div
          class="status-section mt-2"
          [ngClass]="{
            'bg-green-100 text-green-300': selectedMarker.estado?.toUpperCase() === 'DISPONIBLE',
            'bg-yellow-100 text-yellow-300': selectedMarker.estado?.toUpperCase() === 'TOMADO',
            'bg-gray-100 text-gray-300': selectedMarker.estado?.toUpperCase() === 'FINALIZADO'||
                                     selectedMarker.estado?.toUpperCase() === 'NOEXITOSO'    }"
        >
          <span *ngIf="selectedMarker.estado?.toUpperCase() === 'DISPONIBLE'">
            Estado: <strong>DISPONIBLE</strong> (Ofrecida por {{ selectedMarker.usuario }})
          </span>
          <span *ngIf="selectedMarker.estado?.toUpperCase() === 'TOMADO'">
            Estado: <strong>TOMADO</strong> por {{ selectedMarker.tomadoPor || 'un diligenciador' }}
          </span>
          <span *ngIf="selectedMarker.estado?.toUpperCase() === 'FINALIZADO'">
            Estado: <strong>FINALIZADO</strong>
          </span>
          <span *ngIf="selectedMarker.estado?.toUpperCase() === 'NOEXITOSO'">
            Estado: <strong>NO EXITOSO</strong>
          </span>
        </div>

        <!-- CONTENEDOR DE ACCIONES (Tomar/Finalizar/Editar/Eliminar) -->
        <div class="marker-actions mt-3">
          <!-- ACCIÓN PARA TOMAR SOLICITUD (Solo si está disponible y NO soy el dueño) -->
          <button
            *ngIf="
              selectedMarker.estado?.toUpperCase() === 'DISPONIBLE' &&
              selectedMarker.usuario !== currentUser?.username
            "
            class="btn btn-outline-info"
            (click)="takeMarker(selectedMarker!)"
          >
            👉 Tomar Solicitud
          </button>

          <!-- ACCIÓN PARA FINALIZAR SOLICITUD (Solo si está tomado por el usuario actual) -->

          <div class="btn-group" role="group" aria-label="Basic mixed styles example">
            <button
              *ngIf="
                selectedMarker.estado?.toUpperCase() === 'TOMADO' &&
                selectedMarker.tomadoPor !== currentUser?.username
              "
              class="btn btn-outline-success"
              (click)="finishMarker(selectedMarker!)"
              type="button"
            >
              Finalizado
            </button>

            <button
              *ngIf="
                selectedMarker.estado?.toUpperCase() === 'TOMADO' &&
                selectedMarker.tomadoPor !== currentUser?.username
              "
              class="btn btn-outline-danger"
              (click)="noFinishMarker(selectedMarker!)"
              type="button"
            >
              No Finalizado
            </button>
          </div>

          <!-- ACCIÓN DEL PROPIETARIO (Editar/Eliminar) -->
          <ng-container
            *ngIf="
              selectedMarker.usuario === currentUser?.username &&
              selectedMarker.estado?.toUpperCase() === 'DISPONIBLE'
            "
          >
            <div class="btn-group" role="group" aria-label="Basic mixed styles example">
              <button
                type="button"
                class="btn btn-outline-primary"
                (click)="editMarker(selectedMarker!)"
              >
                ✏️ Editar
              </button>
              <button
                type="button"
                class="btn btn-outline-danger"
                (click)="deleteMarker(selectedMarker!)"
              >
                🗑️ Eliminar
              </button>
            </div>
          </ng-container>

          <!-- MENSAJE DE ESTADO (si no hay botón de acción) -->
        </div>
      </div>
    </map-info-window>
  </google-map>
  <!-- MURO: FORMULARIO DE CREACIÓN/EDICIÓN -->
  <div class="muro-container">
    <app-muro
      *ngIf="mostrarMuro"
      [marker]="markerBeingEdited"
      [coordenadasEntrada]="newLocationData"
      (markerUpdated)="onMarkerUpdated($event)"
      (mostrarMapaEvent)="onMostrarMapa()"
    ></app-muro>
  </div>
</div>
